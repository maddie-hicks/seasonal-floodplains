---
title: "Survey Temp Logger Merge and Trim"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 - Cleanup of HOBO survey temperature loggers (white loggers) with column header name adjustment and date-time formatting
 - Cleanup of GPS tracklog data with column header name adjustment and date-time formatting
 - Merge survey temperature data with tracklog data for spatial temperature map
 - Trim data so only contains rows where survey temperature logger was in the water

Clear the workspace and close all graphic devices (two right panels in RStudio).  Bring in the tidyverse package.

```{r}
rm(list = ls())
graphics.off()
library(tidyverse)
library(lubridate)
library(data.table)
```

Check the working directory and change if needed.

```{r}
getwd()
```

SURVEY TEMP LOGGER DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Read in the .csv with survey temperature logger data for each survey. Use "..\\" to back out of the working directory and go into the "Data" folder where the survey temperature logger data is.  Use read_csv as part of the readr package in tidyverse so that the data is automatically made into a tibble instead of a dataframe.


```{r}
AA_Survey_Temp_09212021 <- read_csv("..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\21099530_09212021_AA_James_Brown_Slough_READONLY.csv")
```
Check the data type for each column.  Date-Time is currently assigned as a character (chr) and Temperature is currently assigned as a "double class" (dbl) which are numeric values with decimal points.

```{r}
AA_Survey_Temp_09212021 %>% 
  head()
```

First, change the names of column headers into something more manageable using rename().

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  rename("Date_Time" = "Date Time, GMT-07:00", "Temp_C" = "Temp, Â°C (LGR S/N: 21099530, SEN S/N: 21099530)")
```

Next, change the data type for Date-Time using the lubridate package in tidyverse using as_datetime().  Since the logger data is not in a standard format, you must specify the format that it is in so that R can recognize it.

```{r}
AA_Survey_Temp_09212021$Date_Time <- AA_Survey_Temp_09212021$Date_Time %>%
  as_datetime(format = "%m/%d/%y %H:%M:%S")
```



TRACKLOG DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Now that the survey temperature logger data is cleaned up, read in the .txt with the tracklog data using read_tsv.

```{r}
AA_Tracklog_09212021 <- read_tsv("..\\..\\Data\\Raw Data\\Tracklog Data\\AA_James_Brown_Slough_Tracklog_09212021_READONLY.txt")
```

The column header names look okay so we don't need to rename them.  Next, change the data type for ltime using the lubridate package in tidyverse using as_datetime() like we did with the survey temperature data.  The GPS data is in a standard format so no need to specify the format.

```{r}
AA_Tracklog_09212021$ltime <- AA_Tracklog_09212021$ltime %>%
  as_datetime()
```


DATASET MERGING

Now that both datasets have a column with date-time data in the same format, we can merge them using a rolling join in data.table.  As of now, dplyr doesn't have a rolling join function so we have to use data.table instead.  Since joining two datasets causes one of columns to be dropped we will create a new column in each dataset called Join_DateTime.

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  mutate(Join_DateTime = Date_Time)
AA_Tracklog_09212021 <- AA_Tracklog_09212021 %>%
  mutate(Join_DateTime = ltime)
```

Since we imported the survey temperature data and the GPS data as tibbles, we have to convert it to a data.table using setDT().  Then set the key using setkey() to assign the column to do the rolling join on (Join_DateTime).

```{r}
setDT(AA_Survey_Temp_09212021)
setDT(AA_Tracklog_09212021)
setkey(AA_Survey_Temp_09212021, Join_DateTime)
setkey(AA_Tracklog_09212021, Join_DateTime)
```

Merge the datasets in a rolling join.

```{r}
AA_09212021_Merged <- AA_Survey_Temp_09212021[AA_Tracklog_09212021, roll = TRUE]
```

Since the produced dataset is a data.table, convert it back to a tibble for more data tidying.

```{r}
setDF(AA_09212021_Merged)
AA_09212021_Merged <- as_tibble(AA_09212021_Merged)
```

DATASET TRIMMING

Using the 

```{r}
AA_09212021_Merged_Trim <- AA_09212021_Merged %>%
  slice(c(34:512, 537:704)) %>%
  select(Join_DateTime, Temp_C, Latitude, Longitude)
```

