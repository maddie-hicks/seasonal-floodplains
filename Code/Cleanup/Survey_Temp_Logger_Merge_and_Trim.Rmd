---
title: "Survey Temp Logger Merge and Trim"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 - Cleanup of HOBO survey temperature loggers (white loggers) with column header name adjustment and date-time formatting
 - Cleanup of GPS tracklog data with column header name adjustment and date-time formatting
 - Merge survey temperature data with tracklog data for spatial temperature map
 - Trim data so only contains rows where survey temperature logger was in the water
 - Make functions of this process to apply to all surveys conducted

Clear the workspace and close all graphic devices (two right panels in RStudio).  Bring in necessary packages.

```{r}
rm(list = ls())
graphics.off()
library(tidyverse)
library(lubridate)
library(data.table)
```

Check the working directory and change if needed.

```{r}
getwd()
```

SURVEY TEMP LOGGER DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Read in the .csv with survey temperature logger data for each survey. Use "..\\" to back out of the working directory and go into the "Data" folder where the survey temperature logger data is.  Use read_csv as part of the readr package in tidyverse so that the data is automatically made into a tibble instead of a dataframe.


```{r}
AA_Survey_Temp_09212021 <- read_csv("..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\21099530_09212021_AA_James_Brown_Slough_READONLY.csv")
```
Check the data type for each column.  Date-Time is currently assigned as a character (chr) and Temperature is currently assigned as a "double class" (dbl) which are numeric values with decimal points.

```{r}
AA_Survey_Temp_09212021 %>% 
  head()
```

First, change the names of column headers into something more manageable using rename().

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  rename("Date_Time" = "Date Time, GMT-07:00", "Temp_C" = "Temp, Â°C (LGR S/N: 21099530, SEN S/N: 21099530)")
```

Next, parse the Date_Time column (identify and convert into POSIXct format which is readable by R) using the lubridate package in tidyverse.  When parsing date-time data you must specify the format that the data is currently in.  In this case, it is mdy_hms.

```{r}
AA_Survey_Temp_09212021$Date_Time <- AA_Survey_Temp_09212021$Date_Time %>%
  mdy_hms()
```


TRACKLOG DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Now that the survey temperature logger data is cleaned up, read in the .txt with the tracklog data using read_tsv.

```{r}
AA_Tracklog_09212021 <- read_tsv("..\\..\\Data\\Raw Data\\Tracklog Data\\AA_James_Brown_Slough_Tracklog_09212021_READONLY.txt")
```

The column header names look okay so we don't need to rename them.  Next, parse the ltime column using the lubridate package in tidyverse like we did for the survey temperature data.  When parsing date-time data you must specify the format that the data is currently in.  In this case, it is ymd_hms, again.

```{r}
AA_Tracklog_09212021$ltime <- AA_Tracklog_09212021$ltime %>%
  ymd_hms()
```


DATASET MERGING

Now that both datasets have a column with date-time (POSIXct) data in the same format, we can merge them using a rolling join in data.table.  We are using a rolling join because the intervals on the survey temperature logger and the GPS were slightly different.  As of now, dplyr doesn't have a rolling join function so we have to use data.table instead.  Since joining two datasets causes one of columns to be dropped we will create a new column in each dataset called Join_DateTime.

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  mutate(Join_DateTime = Date_Time)
AA_Tracklog_09212021 <- AA_Tracklog_09212021 %>%
  mutate(Join_DateTime = ltime)
```

Since we imported the survey temperature data and the GPS data as tibbles, we have to convert it to a data.table using setDT().  Then set the key using setkey() to assign the column to do the rolling join on (Join_DateTime).

```{r}
setDT(AA_Survey_Temp_09212021)
setDT(AA_Tracklog_09212021)
setkey(AA_Survey_Temp_09212021, Join_DateTime)
setkey(AA_Tracklog_09212021, Join_DateTime)
```

Merge the datasets in a rolling join.

```{r}
AA_09212021_Merged <- AA_Survey_Temp_09212021[AA_Tracklog_09212021, roll = TRUE]
```

Since the produced dataset is a data.table, convert it back to a tibble for more data tidying.

```{r}
setDF(AA_09212021_Merged)
AA_09212021_Merged <- as_tibble(AA_09212021_Merged)
```


DATASET TRIMMING

Using the survey temperature logger Excel sheet on Dropbox with green shading for rows when the logger was in and out of the water, trim the rows using slice().  Then use select() to get rid of all the extra columns that we don't need.

```{r}
AA_09212021_Merged_Trim <- AA_09212021_Merged %>%
  slice(c(34:512, 537:704)) %>%
  select(Join_DateTime, Temp_C, Latitude, Longitude)
```

Export AA_09212021_Merged_Trim as a .csv in the Derived Data folder in GitHub.  Using # so don't export a new .csv every time the code is run.  Just delete the # when you want to export.

```{r}
#AA_09212021_Merged_Trim %>%
#write_csv("..\\..\\Data\\Derived Data\\Merged and Trimmed Survey Temp and Tracklog\\AA_09212021_Merged_Trim.csv")
```


CREATING FUNCTIONS

Function for getting survey temperature logger data ready to merge (header name cleanup, date-time formatting, copying Date_Time column into Join_DateTime, converting it to a data.table, and setting the key).

```{r}
AAB_Survey_Temp_07132021 <- read_csv("..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\21099530_07132021_AAB_RBK_Sauk_READONLY.csv")

AAB_Survey_Temp_07132021 <- AAB_Survey_Temp_07132021 %>%
  rename("Date_Time" = 2, "Temp_C" = 3)

AAB_Survey_Temp_07132021$Date_Time <- AAB_Survey_Temp_07132021$Date_Time %>%
  mdy_hms()

AAB_Survey_Temp_07132021 %>%
  mutate(Join_DateTime = Date_Time) %>%
  setDT() %>%
  setkey(Join_DateTime)
```

```{r}
prepjoin <- function(filename){

# Read in csv as tibble and do some things to it
  x <- read_csv(filename)
  
  x <- x %>% 
    rename("Date_Time" = 2, "Temp_C" = 3)
  
  x$Date_Time <- x$Date_Time %>% 
    mdy_hms()
  
  x %>% 
    mutate(Join_DateTime = Date_Time) %>%
    setDT() %>%
    setkey(Join_DateTime)
  
  # Figure out what output name should be based on filename
  y <- strsplit(filename, "_")[[1]]
  sitecode <- y[3]
  date <- y[2]
  name <- paste(sitecode, "Survey_Temp", date, sep ="_")
  
  
  # Return tibble/data.table (date_thing) and suggested name
  return(list(data_thing = x, suggested_name = name))
}



#example call

filename <- "..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\21099530_07132021_AAB_RBK_Sauk_READONLY.csv"

out <- prepjoin(filename)

#This assigns an object in the global environment named the suggested name that is the data thing (produced tibble/data.table from the function)
assign(out$suggested_name, out$data_thing)

```


Function for getting tracklog data read to merge (date-time formatting, copying ltime column into Join_DateTime, converting it to a data.table, and setting the key).

```{r}
AAB_Tracklog_07132021 <- read_tsv("..\\..\\Data\\Raw Data\\Tracklog Data\\AAB_RBK_Sauk_Tracklog_07132021_READONLY.txt")

AAB_Tracklog_07132021$ltime <- AAB_Tracklog_07132021$ltime %>%
  ymd_hms()
  
AAB_Tracklog_07132021 <- AAB_Tracklog_07132021 %>%        
  mutate(Join_DateTime = ltime) %>%
  setDT() %>%
  setkey(Join_DateTime)
```

Merging, converting back to a tibble, trimming, and exporting as a .csv can be done manually.



APPLYING FUNCTIONS

Apply these function to each survey temperature logger data .csv file and its corresponding tracklog .txt file starting after AAB RBK Sauk on 07/13/2021.  Make sure to ignore surveys where the tracklog did not record seconds because a rolling join is not possible.






