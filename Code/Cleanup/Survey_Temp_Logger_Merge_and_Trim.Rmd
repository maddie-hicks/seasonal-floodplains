---
title: "Survey Temp Logger Merge and Trim"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 - Cleanup of HOBO survey temperature loggers (white loggers) with column header name adjustment and date-time formatting
 - Cleanup of GPS tracklog data with column header name adjustment and date-time formatting
 - Merge survey temperature data with tracklog data for spatial temperature map
 - Trim data so only contains rows where survey temperature logger was in the water
 - Make functions of this process to apply to all surveys conducted

Clear the workspace and close all graphic devices (two right panels in RStudio).  Bring in necessary packages.

```{r}
rm(list = ls())
graphics.off()
library(tidyverse)
library(lubridate)
library(data.table)
```

Check the working directory and change if needed.

```{r}
getwd()
```

SURVEY TEMP LOGGER DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Read in the .csv with survey temperature logger data for each survey. Use "..\\" to back out of the working directory and go into the "Data" folder where the survey temperature logger data is.  Use read_csv as part of the readr package in tidyverse so that the data is automatically made into a tibble instead of a dataframe.


```{r}
AA_Survey_Temp_09212021 <- read_csv("..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey_Temp_Data_AA_09212021_James_Brown_Slough_READONLY.csv")
```
Check the data type for each column.  Date-Time is currently assigned as a character (chr) and Temperature is currently assigned as a "double class" (dbl) which are numeric values with decimal points.

```{r}
AA_Survey_Temp_09212021 %>% 
  head()
```

First, change the names of column headers into something more manageable using rename().

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  rename("Date_Time" = "Date Time, GMT-07:00", "Temp_C" = "Temp, Â°C (LGR S/N: 21099530, SEN S/N: 21099530)")
```

Next, parse the Date_Time column (identify and convert into POSIXct format which is readable by R) using the lubridate package in tidyverse.  When parsing date-time data you must specify the format that the data is currently in.  In this case, it is mdy_hms.

```{r}
AA_Survey_Temp_09212021$Date_Time <- AA_Survey_Temp_09212021$Date_Time %>%
  mdy_hms()
```


TRACKLOG DATA HEADER CLEANUP AND DATE-TIME FORMATTING

Now that the survey temperature logger data is cleaned up, read in the .txt with the tracklog data using read_tsv.

```{r}
AA_Tracklog_09212021 <- read_tsv("..\\..\\Data\\Raw Data\\Tracklog Data\\Tracklog_Data_AA_09212021_James_Brown_Slough_READONLY.txt")
```

The column header names look okay so we don't need to rename them.  Next, parse the ltime column using the lubridate package in tidyverse like we did for the survey temperature data.  When parsing date-time data you must specify the format that the data is currently in.  In this case, it is ymd_hms.

```{r}
AA_Tracklog_09212021$ltime <- AA_Tracklog_09212021$ltime %>%
  ymd_hms()
```


DATASET MERGING

Now that both datasets have a column with date-time (POSIXct) data in the same format, we can merge them using a rolling join in data.table.  We are using a rolling join because the intervals on the survey temperature logger and the GPS were slightly different.  As of now, dplyr doesn't have a rolling join function so we have to use data table instead.  Since joining two datasets causes one of columns to be dropped we will create a new column in each dataset called Join_DateTime.

```{r}
AA_Survey_Temp_09212021 <- AA_Survey_Temp_09212021 %>%
  mutate(Join_DateTime = Date_Time)
AA_Tracklog_09212021 <- AA_Tracklog_09212021 %>%
  mutate(Join_DateTime = ltime)
```

Since we imported the survey temperature data and the GPS data as tibbles, we have to convert it to a data table using setDT().  Then set the key using setkey() to assign the column to do the rolling join on (Join_DateTime).

```{r}
setDT(AA_Survey_Temp_09212021)
setDT(AA_Tracklog_09212021)
setkey(AA_Survey_Temp_09212021, Join_DateTime)
setkey(AA_Tracklog_09212021, Join_DateTime)
```

Merge the datasets in a rolling join.

```{r}
AA_09212021_Merged <- AA_Survey_Temp_09212021[AA_Tracklog_09212021, roll = TRUE]
```

Since the produced dataset is a data table, convert it back to a tibble for more data tidying.

```{r}
setDF(AA_09212021_Merged)
AA_09212021_Merged <- as_tibble(AA_09212021_Merged)
```


DATASET TRIMMING

Using the survey temperature logger Excel sheet on Dropbox with green shading for rows when the logger was in and out of the water, trim the rows using slice().  Then use select() to get rid of all the extra columns that we don't need.

```{r}
AA_09212021_Merged_Trim <- AA_09212021_Merged %>%
  slice(c(34:512, 537:704)) %>%
  select(Join_DateTime, Temp_C, Latitude, Longitude)
```

Export AA_09212021_Merged_Trim as a .csv in the Derived Data folder in GitHub.  Using # so don't export a new .csv every time the code is run.  Just delete the # when you want to export.

```{r}
# AA_09212021_Merged_Trim %>%
# write_csv("..\\..\\Data\\Derived Data\\Merged and Trimmed Survey Temp and Tracklog\\AA_09212021_Merged_Trim.csv")
```


SURVEY TEMP LOGGER PREP FUNCTION

Below is the workflow for getting survey temperature logger data ready to merge (header name cleanup, date-time formatting, copying Date_Time column into Join_DateTime, converting it to a data table, and setting the key).

```{r}
# AAB_Survey_Temp_07132021 <- read_csv("..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey_Temp_Data_AAB_07132021_RBK_Sauk_READONLY.csv")

# AAB_Survey_Temp_07132021 <- AAB_Survey_Temp_07132021 %>%
  # rename("Date_Time" = 2, "Temp_C" = 3)

# AAB_Survey_Temp_07132021$Date_Time <- AAB_Survey_Temp_07132021$Date_Time %>%
  # mdy_hms()

# AAB_Survey_Temp_07132021 <- AAB_Survey_Temp_07132021 %>%
  # mutate(Join_DateTime = Date_Time) %>%
  # setDT() %>%
  # setkey(Join_DateTime)
```

This is the function created from that workflow.

```{r}
Survey_Temp_Prep_Join_Function <- function(Survey_Temp_File_Name){

  # This is the same workflow as in the code chunk above
  
  Survey_Temp_Data <- read_csv(Survey_Temp_File_Name)
  
  Survey_Temp_Data <- Survey_Temp_Data %>% 
    rename("Date_Time" = 2, "Temp_C" = 3)
  
  Survey_Temp_Data$Date_Time <- Survey_Temp_Data$Date_Time %>% 
    mdy_hms()
  
  Survey_Temp_Data <- Survey_Temp_Data %>% 
    mutate(Join_DateTime = Date_Time) %>%
    setDT() %>%
    setkey(Join_DateTime)
  
  # Figure out what output name (R object going in the global environment) should be based on imported .csv file name
  # strsplit() allows you to split the imported .csv file name.  In this case we are telling R to split by "_"
  # For example "..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey_Temp_Data_AAB_07132021_RBK_Sauk_READONLY.csv" would be split into list [[1]] with the items [1] ..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey [2] Temp [3] Data [4] AAB [5] 07132021 [6] RBK [7] Sauk [8] READONLY
  # Specify the list number [[1]] and then assign how you want the object to be named based off of the items in the list
  
  Survey_Temp_File_Name_Split <- strsplit(Survey_Temp_File_Name, "_")[[1]]
  Survey_Temp_Site_Code <- Survey_Temp_File_Name_Split[4]
  Survey_Temp_Date <- Survey_Temp_File_Name_Split[5]
  Survey_Temp_Object_Name <- paste(Survey_Temp_Site_Code, "Survey_Temp", Survey_Temp_Date, sep ="_")
  
  
  # Return is what is spit out by the function when you do a call
  # Return produced data table Survey_Temp_Data (which we called "Data" although you don't need to name them) and suggested object name (which we called "Suggested_Name")
  
  return(list(Data = Survey_Temp_Data, Suggested_Name =  Survey_Temp_Object_Name))
}
```

```{r}
# Example call using the function

Survey_Temp_File_Name <- "..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey_Temp_Data_AAB_07132021_RBK_Sauk_READONLY.csv"

Survey_Temp_Call <- Survey_Temp_Prep_Join_Function(Survey_Temp_File_Name)

#This assigns an object in the global environment named the suggested name that is the data thing (produced tibble/data table from the function)

assign(Survey_Temp_Call$Suggested_Name, Survey_Temp_Call$Data)
```

TRACKLOG PREP FUNCTION

Below is the workflow for getting tracklog data read to merge (date-time formatting, copying ltime column into Join_DateTime, converting it to a data table, and setting the key).

```{r}
# AAB_Tracklog_07132021 <- read_tsv("..\\..\\Data\\Raw Data\\Tracklog Data\\AAB_RBK_Sauk_Tracklog_07132021_READONLY.txt")

# AAB_Tracklog_07132021$ltime <- AAB_Tracklog_07132021$ltime %>%
  # ymd_hms()
  
# AAB_Tracklog_07132021 <- AAB_Tracklog_07132021 %>%        
  # mutate(Join_DateTime = ltime) %>%
  # setDT() %>%
  # setkey(Join_DateTime)
```

This is the function created from that workflow.

```{r}
Tracklog_Prep_Join_Function <- function(Tracklog_File_Name){

  # This is the same workflow as in the code chunk above
  
  Tracklog_Data <- read_tsv(Tracklog_File_Name)
  
  Tracklog_Data$ltime <- Tracklog_Data$ltime %>% 
    ymd_hms()
  
  Tracklog_Data <- Tracklog_Data %>% 
    mutate(Join_DateTime = ltime) %>%
    setDT() %>%
    setkey(Join_DateTime)
  
  # Figure out what output name (R object going in the global environment) should be based on imported .tsv file name
  # strsplit() allows you to split the imported .tsv file name.  In this case we are telling R to split by "_"
  # For example "..\\..\\Data\\Raw Data\\Tracklog Data\\Tracklog_Data_AAB_07132021_RBK_Sauk_READONLY.txt" would be split into list [[1]] with the items [1] ..\\..\\Data\\Raw Data\\Tracklog Data\\Tracklog [2] Data [3] AAB [4] 07132021 [5] RBK [6] Sauk [7] READONLY
  # Specify the list number [[1]] and then assign how you want the object to be named based off of the items in the list
  
  Tracklog_File_Name_Split <- strsplit(Tracklog_File_Name, "_")[[1]]
  Tracklog_Site_Code <- Tracklog_File_Name_Split[3]
  Tracklog_Date <- Tracklog_File_Name_Split[4]
  Tracklog_Object_Name <- paste(Tracklog_Site_Code, "Tracklog", Tracklog_Date, sep ="_")
  
  
  # Return is what is spit out by the function when you do a call
  # Return produced data table Tracklog_Data (which we called "Data" although you don't need to name them) and suggested object name (which we called "Suggested_Name")
  
  return(list(Data = Tracklog_Data, Suggested_Name =  Tracklog_Object_Name))
}
```

```{r}
# Example call using the function

Tracklog_File_Name <- "..\\..\\Data\\Raw Data\\Tracklog Data\\Tracklog_Data_AAB_07132021_RBK_Sauk_READONLY.txt"

Tracklog_Call <- Tracklog_Prep_Join_Function(Tracklog_File_Name)

#This assigns an object in the global environment named the suggested name that is the data thing (produced tibble/data table from the function)

assign(Tracklog_Call$Suggested_Name, Tracklog_Call$Data)
```

Merging, converting back to a tibble, trimming, and exporting as a .csv can be done manually.

```{r}
AAB_07132021_Merged <- AAB_Survey_Temp_07132021[AAB_Tracklog_07132021, roll = TRUE]
setDF(AAB_07132021_Merged)
AAB_07132021_Merged <- as_tibble(AAB_07132021_Merged)
AAB_07132021_Merged_Trim <- AAB_07132021_Merged %>%
  slice(c(29:167, 201:277)) %>%
  select(Join_DateTime, Temp_C, Latitude, Longitude)
# AAB_07132021_Merged_Trim %>%
# write_csv("..\\..\\Data\\Derived Data\\Merged and Trimmed Survey Temp and Tracklog\\AAB_07132021_Merged_Trim.csv")
```


APPLYING FUNCTIONS

Apply these function to each survey temperature logger data .csv file and its corresponding tracklog .txt file starting after AAB RBK Sauk on 07/13/2021.  Make sure to ignore surveys where the tracklog did not record seconds because a rolling join is not possible.


AAC_07122021

```{r}
Survey_Temp_File_Name <- "..\\..\\Data\\Raw Data\\Survey Temperature Logger Data\\Survey_Temp_Data_AAB_07132021_RBK_Sauk_READONLY.csv"
Survey_Temp_Call <- Survey_Temp_Prep_Join_Function(Survey_Temp_File_Name)
assign(Survey_Temp_Call$Suggested_Name, Survey_Temp_Call$Data)

Tracklog_File_Name <- "..\\..\\Data\\Raw Data\\Tracklog Data\\Tracklog_Data_AAB_07132021_RBK_Sauk_READONLY.txt"
Tracklog_Call <- Tracklog_Prep_Join_Function(Tracklog_File_Name)
assign(Tracklog_Call$Suggested_Name, Tracklog_Call$Data)

AAB_07132021_Merged <- AAB_Survey_Temp_07132021[AAB_Tracklog_07132021, roll = TRUE]
setDF(AAB_07132021_Merged)
AAB_07132021_Merged <- as_tibble(AAB_07132021_Merged)
AAB_07132021_Merged_Trim <- AAB_07132021_Merged %>%
  slice(c(29:167, 201:277)) %>%
  select(Join_DateTime, Temp_C, Latitude, Longitude)
# AAB_07132021_Merged_Trim %>%
# write_csv("..\\..\\Data\\Derived Data\\Merged and Trimmed Survey Temp and Tracklog\\AAB_07132021_Merged_Trim.csv")
```


AAC_10192021






